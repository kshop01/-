<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>院内店舗 ご意見・お問い合わせフォーム</title>
    <!-- Tailwind CSS CDNの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 日付・時間入力欄のスタイル調整 */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(175deg); /* 青色に調整 */
        }
        /* ボタンのスタイル */
        .btn {
            @apply flex items-center justify-center space-x-2 font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-md;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }
        .btn-secondary {
            @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ご意見・お問い合わせフォーム</h1>
        <p class="text-center text-gray-600 mb-8">
            日頃より当院内店舗をご利用いただき、誠にありがとうございます。<br>
            より良いサービス向上のため、お客様のご意見をお聞かせください。
        </p>

        <!-- Formspreeの送信先URLをaction属性に設定 -->
        <!-- "YOUR_FORMSPREE_ENDPOINT_URL"をご自身のURLに置き換えてください -->
        <form id="feedbackForm" action="https://formspree.io/f/YOUR_FORMSPREE_ENDPOINT_URL" method="POST" class="space-y-6">
            <!-- 日付・時間記入セクション -->
            <div class="bg-gray-50 p-4 rounded-xl">
                <label for="feedbackDate" class="block text-lg font-medium text-gray-700 mb-2">ご意見日</label>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="date" id="feedbackDate" name="feedbackDate" class="w-full sm:w-1/2 p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors duration-200">
                    <input type="time" id="feedbackTime" name="feedbackTime" class="w-full sm:w-1/2 p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors duration-200">
                </div>
            </div>
        
            <!-- 評価項目セクション -->
            <div class="space-y-6">
                <!-- 追加項目：接客 -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-lg font-medium text-gray-700 mb-2">接客</label>
                    <div class="flex justify-between items-center text-center text-sm sm:text-base">
                        <span class="text-gray-500 w-1/5">不満</span>
                        <div class="flex-1 flex justify-around">
                            <label class="cursor-pointer group">
                                <input type="radio" name="customerServiceRating" value="1" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-red-400 hover:text-white transition-colors duration-200 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">1</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="customerServiceRating" value="2" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-orange-400 hover:text-white transition-colors duration-200 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">2</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="customerServiceRating" value="3" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-yellow-400 hover:text-white transition-colors duration-200 peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500">3</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="customerServiceRating" value="4" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-lime-400 hover:text-white transition-colors duration-200 peer-checked:bg-lime-500 peer-checked:text-white peer-checked:border-lime-500">4</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="customerServiceRating" value="5" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-green-400 hover:text-white transition-colors duration-200 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500">5</span>
                            </label>
                        </div>
                        <span class="text-gray-500 w-1/5">満足</span>
                    </div>
                </div>

                <!-- 項目1：スタッフの対応 -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-lg font-medium text-gray-700 mb-2">スタッフの対応</label>
                    <div class="flex justify-between items-center text-center text-sm sm:text-base">
                        <span class="text-gray-500 w-1/5">不満</span>
                        <div class="flex-1 flex justify-around">
                            <label class="cursor-pointer group">
                                <input type="radio" name="staffRating" value="1" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-red-400 hover:text-white transition-colors duration-200 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">1</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="staffRating" value="2" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-orange-400 hover:text-white transition-colors duration-200 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">2</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="staffRating" value="3" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-yellow-400 hover:text-white transition-colors duration-200 peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500">3</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="staffRating" value="4" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-lime-400 hover:text-white transition-colors duration-200 peer-checked:bg-lime-500 peer-checked:text-white peer-checked:border-lime-500">4</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="staffRating" value="5" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-green-400 hover:text-white transition-colors duration-200 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500">5</span>
                            </label>
                        </div>
                        <span class="text-gray-500 w-1/5">満足</span>
                    </div>
                </div>

                <!-- 項目2：品揃え -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-lg font-medium text-gray-700 mb-2">品揃え</label>
                    <div class="flex justify-between items-center text-center text-sm sm:text-base">
                        <span class="text-gray-500 w-1/5">不満</span>
                        <div class="flex-1 flex justify-around">
                            <label class="cursor-pointer group">
                                <input type="radio" name="selectionRating" value="1" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-red-400 hover:text-white transition-colors duration-200 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">1</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="selectionRating" value="2" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-orange-400 hover:text-white transition-colors duration-200 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">2</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="selectionRating" value="3" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-yellow-400 hover:text-white transition-colors duration-200 peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500">3</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="selectionRating" value="4" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-lime-400 hover:text-white transition-colors duration-200 peer-checked:bg-lime-500 peer-checked:text-white peer-checked:border-lime-500">4</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="selectionRating" value="5" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-green-400 hover:text-white transition-colors duration-200 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500">5</span>
                            </label>
                        </div>
                        <span class="text-gray-500 w-1/5">満足</span>
                    </div>
                </div>

                <!-- 項目3：清潔感 -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-lg font-medium text-gray-700 mb-2">清潔感</label>
                    <div class="flex justify-between items-center text-center text-sm sm:text-base">
                        <span class="text-gray-500 w-1/5">不満</span>
                        <div class="flex-1 flex justify-around">
                            <label class="cursor-pointer group">
                                <input type="radio" name="cleanlinessRating" value="1" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-red-400 hover:text-white transition-colors duration-200 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">1</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="cleanlinessRating" value="2" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-orange-400 hover:text-white transition-colors duration-200 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500">2</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="cleanlinessRating" value="3" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-yellow-400 hover:text-white transition-colors duration-200 peer-checked:bg-yellow-500 peer-checked:text-white peer-checked:border-yellow-500">3</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="cleanlinessRating" value="4" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-lime-400 hover:text-white transition-colors duration-200 peer-checked:bg-lime-500 peer-checked:text-white peer-checked:border-lime-500">4</span>
                            </label>
                            <label class="cursor-pointer group">
                                <input type="radio" name="cleanlinessRating" value="5" class="hidden peer">
                                <span class="block w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full border-2 border-gray-300 text-gray-700 font-bold hover:bg-green-400 hover:text-white transition-colors duration-200 peer-checked:bg-green-500 peer-checked:text-white peer-checked:border-green-500">5</span>
                            </label>
                        </div>
                        <span class="text-gray-500 w-1/5">満足</span>
                    </div>
                </div>
            </div>

            <!-- その他ご意見セクション -->
            <div>
                <label for="otherComments" class="block text-lg font-medium text-gray-700 mb-2">その他ご意見・ご要望</label>
                <textarea id="otherComments" name="otherComments" rows="5" class="mt-1 block w-full p-3 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 outline-none transition-colors duration-200"></textarea>
            </div>
            
            <!-- Gemini APIボタンセクション -->
            <div class="flex flex-col sm:flex-row gap-4 justify-end">
                <button type="button" id="summarizeBtn" class="btn btn-secondary">
                    <span id="summarizeText">ご意見の自動要約 ✨</span>
                    <div id="summarizeLoading" class="hidden loading-spinner"></div>
                </button>
                <button type="button" id="replyBtn" class="btn btn-secondary">
                    <span id="replyText">返信文案の作成 ✨</span>
                    <div id="replyLoading" class="hidden loading-spinner"></div>
                </button>
            </div>

            <!-- Gemini APIからの出力結果を表示するコンテナ -->
            <div id="geminiOutput" class="hidden bg-gray-100 p-4 rounded-xl mt-4 space-y-4">
                <div id="summaryOutput" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">要約:</h3>
                    <p id="summaryResult" class="text-gray-700"></p>
                </div>
                <div id="replyOutput" class="hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">返信文案:</h3>
                    <div class="relative bg-white rounded-lg shadow-inner border border-gray-300 p-4">
                        <textarea id="replyResult" rows="5" readonly class="w-full h-full bg-transparent outline-none resize-none text-gray-700"></textarea>
                        <button id="copyReplyBtn" class="absolute top-2 right-2 bg-gray-200 text-gray-600 rounded-md p-1 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M8 2a2 2 0 00-2 2v2H5a2 2 0 00-2 2v9a2 2 0 002 2h6a2 2 0 002-2v-3h2a2 2 0 002-2V8a2 2 0 00-2-2h-3V4a2 2 0 00-2-2H8z" />
                                <path d="M11 6a1 1 0 100-2H8a1 1 0 00-1 1v1h4z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 送信ボタン -->
            <div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 shadow-md">送信する</button>
            </div>
        </form>
    </div>

    <script>
        // APIキーは実行時に自動で提供されるため、空文字のままでOK
        const apiKey = "";
        
        // ローディングUIの表示/非表示を切り替える関数
        function toggleLoading(buttonId, loadingId, textId, isLoading) {
            const button = document.getElementById(buttonId);
            const loadingSpinner = document.getElementById(loadingId);
            const buttonText = document.getElementById(textId);
            if (isLoading) {
                button.disabled = true;
                loadingSpinner.classList.remove('hidden');
                buttonText.classList.add('hidden');
            } else {
                button.disabled = false;
                loadingSpinner.classList.add('hidden');
                buttonText.classList.remove('hidden');
            }
        }

        // Gemini API呼び出しの共通処理
        async function callGeminiApi(prompt) {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = {
                contents: chatHistory,
                generationConfig: {
                    temperature: 0.7,
                },
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            // 指数バックオフ付きのAPI呼び出し
            const maxRetries = 5;
            let currentRetry = 0;
            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('API response format is unexpected.');
                    }
                } catch (error) {
                    currentRetry++;
                    if (currentRetry < maxRetries) {
                        const delay = Math.pow(2, currentRetry) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error('Failed to call Gemini API after multiple retries:', error);
                        throw error;
                    }
                }
            }
        }

        const summarizeBtn = document.getElementById('summarizeBtn');
        const replyBtn = document.getElementById('replyBtn');
        const otherCommentsTextarea = document.getElementById('otherComments');
        const geminiOutputContainer = document.getElementById('geminiOutput');
        const summaryOutput = document.getElementById('summaryOutput');
        const summaryResult = document.getElementById('summaryResult');
        const replyOutput = document.getElementById('replyOutput');
        const replyResult = document.getElementById('replyResult');
        const copyReplyBtn = document.getElementById('copyReplyBtn');

        // ご意見の自動要約機能
        summarizeBtn.addEventListener('click', async () => {
            const comments = otherCommentsTextarea.value.trim();
            if (comments === "") {
                // カスタムアラート機能が必要な場合はここに実装
                // alert('ご意見・ご要望を入力してください。');
                return;
            }
            
            toggleLoading('summarizeBtn', 'summarizeLoading', 'summarizeText', true);
            geminiOutputContainer.classList.remove('hidden');
            summaryOutput.classList.remove('hidden');
            replyOutput.classList.add('hidden'); // 他の出力を非表示
            summaryResult.textContent = '要約中です...';

            try {
                const prompt = `以下の文章を簡潔に要約してください。:\n\n${comments}`;
                const summary = await callGeminiApi(prompt);
                summaryResult.textContent = summary;
            } catch (error) {
                summaryResult.textContent = '要約中にエラーが発生しました。';
            } finally {
                toggleLoading('summarizeBtn', 'summarizeLoading', 'summarizeText', false);
            }
        });

        // 返信文案の作成機能
        replyBtn.addEventListener('click', async () => {
            const comments = otherCommentsTextarea.value.trim();
            if (comments === "") {
                // alert('ご意見・ご要望を入力してください。');
                return;
            }
            
            toggleLoading('replyBtn', 'replyLoading', 'replyText', true);
            geminiOutputContainer.classList.remove('hidden');
            replyOutput.classList.remove('hidden');
            summaryOutput.classList.add('hidden'); // 他の出力を非表示
            replyResult.value = '返信文案を作成中です...';

            try {
                const prompt = `以下の顧客からのご意見に対して、丁寧で感謝を伝える返信文案を作成してください。: \n\n${comments}`;
                const reply = await callGeminiApi(prompt);
                replyResult.value = reply;
            } catch (error) {
                replyResult.value = '返信文案の作成中にエラーが発生しました。';
            } finally {
                toggleLoading('replyBtn', 'replyLoading', 'replyText', false);
            }
        });

        // 返信文案をクリップボードにコピー
        copyReplyBtn.addEventListener('click', () => {
            replyResult.select();
            document.execCommand('copy');
            // コピー成功のフィードバックを追加することも可能
            // alert('返信文案をコピーしました！');
        });

    </script>
</body>
</html>
